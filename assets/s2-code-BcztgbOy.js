import{S as U,x as L,w as m,i as S,j as D,k as G,q as y,r as f,s as l,o as b,n as h,y as _,A as M,M as r,B as N,z as H,b as w,l as z,m as B,p as E,d as j}from"./s2-lerp-anim-3QYG2S63.js";class I{lower;upper;constructor(){this.lower=new U,this.upper=new U}setFromPoints(t){if(t.length===0)return this.lower.set(0,0),this.upper.set(0,0),this;this.lower.set(1/0,1/0),this.upper.set(-1/0,-1/0);for(const e of t)this.lower.minV(e),this.upper.maxV(e);return this}setEmpty(){return this.lower.set(1/0,1/0),this.upper.set(-1/0,-1/0),this}expandToInclude(t){return this.lower.minV(t),this.upper.maxV(t),this}getCenter(){return this.lower.clone().addV(this.upper).scale(.5)}getExtents(){return this.upper.clone().subV(this.lower).scale(.5)}isPointInside(t){return t.x>=this.lower.x&&t.x<=this.upper.x&&t.y>=this.lower.y&&t.y<=this.upper.y}expand(t){return this.lower.x-=t,this.lower.y-=t,this.upper.x+=t,this.upper.y+=t,this}clone(){const t=new I;return t.lower.copy(this.lower),t.upper.copy(this.upper),t}copy(t){return this.lower.copy(t.lower),this.upper.copy(t.upper),this}}class q extends G{fill;stroke;opacity;cornerRadius;padding;constructor(){super(),this.fill=new y,this.stroke=new f,this.opacity=new l(1),this.cornerRadius=new b(5,"view"),this.padding=new h(4,2,"view"),this.stroke.opacity.set(1),this.fill.opacity.set(1)}setOwner(t=null){this.fill.setOwner(t),this.stroke.setOwner(t),this.opacity.setOwner(t),this.cornerRadius.setOwner(t),this.padding.setOwner(t)}clearDirty(){super.clearDirty(),this.fill.clearDirty(),this.stroke.clearDirty(),this.opacity.clearDirty(),this.cornerRadius.clearDirty(),this.padding.clearDirty()}}class v extends L{rect;references;constructor(t){super(t,new q),this.rect=new m(t),this.references=[],this.rect.getSVGElement().role="text-highlight"}addReference(t){return this.references.push(t),this.markDirty(),this}addReferences(...t){return this.references.push(...t),this.markDirty(),this}clearReferences(){return this.references=[],this}getSVGElement(){return this.rect.getSVGElement()}animateFadeIn(t,e={}){const s=t.ensureLabel(e.label),i=e.offset??0,a=e.duration??500;this.data.opacity.set(0);const n=S.create(this.scene,this.data.opacity).setCycleDuration(a).setEasing(D.inOut);return this.data.opacity.set(1),n.commitFinalState(),t.addAnimation(n,s,i),t.enableElement(this,!0,s,i),this}animateFadeOut(t,e={}){const s=t.ensureLabel(e.label),i=e.offset??0,a=e.duration??500;this.data.opacity.set(1);const n=S.create(this.scene,this.data.opacity).setCycleDuration(a).setEasing(D.inOut);return this.data.opacity.set(0),n.commitFinalState(),t.addAnimation(n,s,i),t.enableElement(this,!1,s,i+a),this}update(){if(!this.isDirty()||this.references.length===0)return;const t=this.scene.getActiveCamera(),e="view",s=new I().setEmpty();for(const c of this.references)s.expandToInclude(c.getLower(e)),s.expandToInclude(c.getUpper(e));const i=s.getExtents(),a=s.getCenter(),n=this.data.padding.get(e,t);this.rect.data.position.setV(a,e),this.rect.data.extents.set(i.x+n.x,i.y+n.y,e),this.rect.data.anchor.set("center"),this.rect.data.fill.copyIfUnlocked(this.data.fill),this.rect.data.stroke.copyIfUnlocked(this.data.stroke),this.rect.data.opacity.copyIfUnlocked(this.data.opacity),this.rect.data.cornerRadius.copyIfUnlocked(this.data.cornerRadius),this.rect.update(),this.clearDirty()}}function X(o){const t=[],e=/\*\*(\w+):(.*?)\*\*|(\s+)|([();,.])|([^\s();,.]+)/g;for(const s of o.split(`
`)){let i;for(;(i=e.exec(s))!==null;)i[1]?t.push({type:i[1],value:i[2]}):i[3]?t.push({type:"space",value:i[3]}):i[4]?t.push({type:"punct",value:i[4]}):i[5]&&t.push({type:"plain",value:i[5]});t.push({type:"newline",value:`
`})}return t.pop(),t}class W extends G{position;opacity;anchor;padding;minExtents;text;background;currentLine;constructor(){super(),this.position=new z(0,0,"world"),this.anchor=new B("center"),this.padding=new h(10,5,"view"),this.minExtents=new h(0,0,"view"),this.text=new Y,this.background=new J,this.currentLine=new K,this.opacity=new l(1)}setOwner(t=null){super.setOwner(t),this.position.setOwner(t),this.anchor.setOwner(t),this.padding.setOwner(t),this.minExtents.setOwner(t),this.text.setOwner(t),this.background.setOwner(t),this.currentLine.setOwner(t),this.opacity.setOwner(t)}clearDirty(){super.clearDirty(),this.position.clearDirty(),this.anchor.clearDirty(),this.padding.clearDirty(),this.minExtents.clearDirty(),this.text.clearDirty(),this.background.clearDirty(),this.currentLine.clearDirty(),this.opacity.clearDirty()}}class Y extends E{fill;stroke;opacity;font;verticalAlign;constructor(){super(),this.fill=new y,this.stroke=new f,this.opacity=new l(1),this.font=new j,this.verticalAlign=new B("middle"),this.stroke.width.set(0,"view"),this.fill.opacity.set(1)}setOwner(t=null){this.fill.setOwner(t),this.stroke.setOwner(t),this.opacity.setOwner(t),this.font.setOwner(t),this.verticalAlign.setOwner(t)}clearDirty(){this.fill.clearDirty(),this.stroke.clearDirty(),this.opacity.clearDirty(),this.font.clearDirty(),this.verticalAlign.clearDirty()}}class J extends E{fill;stroke;opacity;cornerRadius;constructor(){super(),this.fill=new y,this.stroke=new f,this.opacity=new l(1),this.cornerRadius=new b(5,"view"),this.stroke.opacity.set(1),this.fill.opacity.set(1)}setOwner(t=null){this.fill.setOwner(t),this.stroke.setOwner(t),this.opacity.setOwner(t),this.cornerRadius.setOwner(t)}clearDirty(){this.fill.clearDirty(),this.stroke.clearDirty(),this.opacity.clearDirty(),this.cornerRadius.clearDirty()}}class K extends E{fill;stroke;opacity;index;padding;constructor(){super(),this.fill=new y,this.stroke=new f,this.opacity=new l(0),this.index=new l(0),this.padding=new h(0,1,"view"),this.stroke.opacity.set(1),this.fill.opacity.set(1)}setOwner(t=null){this.fill.setOwner(t),this.stroke.setOwner(t),this.opacity.setOwner(t),this.index.setOwner(t),this.padding.setOwner(t)}clearDirty(){this.fill.clearDirty(),this.stroke.clearDirty(),this.opacity.clearDirty(),this.index.clearDirty(),this.padding.clearDirty()}}class C extends L{element;textGroup;codeBackground;lineBackground;extents;tokenStyleSetter=C.defaultTokenStyleSetter;highlights;constructor(t){super(t,new W),this.element=document.createElementNS(_,"g"),this.textGroup=new M(t),this.codeBackground=new m(t),this.lineBackground=new m(t),this.extents=new h(0,0,"view"),this.highlights=[],this.textGroup.setParent(this),this.codeBackground.setParent(this),this.lineBackground.setParent(this),this.textGroup.data.layer.set(2),this.codeBackground.data.layer.set(0),this.lineBackground.data.layer.set(0),this.element.dataset.role="code",this.updateSVGChildren()}setTokenStyleSetter(t){return this.tokenStyleSetter=t,this}static defaultTokenStyleSetter(t,e){switch(e){case"fn":t.data.fill.color.copyIfUnlocked(r.ORANGE_2).lock();break;case"type":t.data.fill.color.copyIfUnlocked(r.BLUE_3).lock();break;case"kw":t.data.fill.color.copyIfUnlocked(r.PURPLE_3).lock();break;case"var":t.data.fill.color.copyIfUnlocked(r.LIGHT_BLUE_1).lock();break;case"num":t.data.fill.color.copyIfUnlocked(r.LIME_2).lock();break;case"str":t.data.fill.color.copyIfUnlocked(r.DEEP_ORANGE_2).lock();break;case"punct":t.data.fill.color.copyIfUnlocked(r.PURPLE_1).lock();break}}animateSetCurrentLine(t,e,s={}){const i=e.ensureLabel(s.label),a=s.offset??0,n=s.duration??500;s.prevIndex!==void 0&&this.data.currentLine.index.set(s.prevIndex);const c=S.create(this.scene,this.data.currentLine.index).setCycleDuration(n).setEasing(D.inOut);return this.data.currentLine.index.set(t),e.addAnimation(c.commitFinalState(),i,a),this}findTokenTSpan(t,e){return this.textGroup.getLine(t).findTSpan(e)}createTokenHighlight(t,e){const s=e??r.BLUE_5,i=new v(this.scene);i.data.fill.opacity.set(.15),i.data.fill.color.copyIfUnlocked(s),i.data.stroke.color.copyIfUnlocked(s),i.data.stroke.width.set(1,"view"),i.data.layer.set(1),i.setParent(this);for(const a of t){const n=this.findTokenTSpan(a.lineIndex,{content:a.content,category:a.category});n?i.addReference(n):console.warn("Token not found for highlight:",a)}return this.highlights.push(i),i}createEmphasisForToken(t,e){const s=this.findTokenTSpan(t,e);if(!s)return null;const i=new v(this.scene);return i.data.fill.opacity.set(.2),i.data.fill.color.copyIfUnlocked(r.BLUE_9),i.data.stroke.color.copyIfUnlocked(r.BLUE_5),i.data.stroke.width.set(1,"view"),i.data.layer.set(1),i.setParent(this),i.addReference(s),i.update(),this.highlights.push(i),i}detachEmphasisRect(t){const e=this.highlights.indexOf(t);return e!==-1&&this.highlights.splice(e,1),t.setParent(null),this}setContent(t){let e=this.textGroup.addLine();for(const s of t)if(e.data.preserveWhitespace.set(!0),s.type==="plain")e.addTSpan(s.value);else if(s.type==="newline")e=this.textGroup.addLine();else{const i=e.addTSpan(s.value,s.type);this.tokenStyleSetter(i,s.type)}}getExtents(t){return this.extents.get(t,this.scene.getActiveCamera())}getSVGElement(){return this.element}update(){if(this.skipUpdate())return;const t=this.scene.getActiveCamera(),e="view";this.updateSVGChildren(),N.applyOpacity(this.data.opacity,this.element,this.scene),this.textGroup.data.font.copyIfUnlocked(this.data.text.font),this.textGroup.data.horizontalAlign.set("left"),this.textGroup.data.verticalAlign.copyIfUnlocked(this.data.text.verticalAlign),this.textGroup.data.fill.copyIfUnlocked(this.data.text.fill),this.textGroup.data.opacity.copyIfUnlocked(this.data.text.opacity),this.textGroup.data.stroke.copyIfUnlocked(this.data.text.stroke),this.textGroup.update();const s=this.textGroup.getExtents(e),i=this.data.padding.get(e,t),a=this.data.minExtents.get(e,t),n=s.addV(i);n.maxV(a),this.extents.setV(n,e);const c=n.clone().subV(i),g=H.getCenter(this.data.anchor.get(),e,t,this.data.position,this.extents);this.textGroup.data.minExtents.setV(c,e),this.textGroup.data.position.setV(g,e),this.textGroup.update(),this.codeBackground.data.position.setV(g,"view"),this.codeBackground.data.extents.setV(n,"view"),this.codeBackground.data.cornerRadius.copyIfUnlocked(this.data.background.cornerRadius),this.codeBackground.data.fill.copyIfUnlocked(this.data.background.fill),this.codeBackground.data.stroke.copyIfUnlocked(this.data.background.stroke),this.codeBackground.data.opacity.copyIfUnlocked(this.data.background.opacity),this.codeBackground.update(),this.lineBackground.data.fill.copyIfUnlocked(this.data.currentLine.fill),this.lineBackground.data.stroke.copyIfUnlocked(this.data.currentLine.stroke),this.lineBackground.data.opacity.copyIfUnlocked(this.data.currentLine.opacity);const d=this.textGroup.getLineCount();if(d>0){const p=this.data.currentLine.padding.get(e,t),k=w.clamp(this.data.currentLine.index.get(),0,d-1),x=w.clamp(Math.floor(k),0,d-1),O=w.clamp(Math.ceil(k),0,d-1),u=k-x,T=this.textGroup.getLine(x).getExtents(e),R=this.textGroup.getLine(O).getExtents(e),A=this.textGroup.getLine(x).getCenter(e),V=this.textGroup.getLine(O).getCenter(e),P=T.y*(1-u)+R.y*u,F=A.y*(1-u)+V.y*u;this.lineBackground.data.position.set(g.x,F,"view"),this.lineBackground.data.extents.set(n.x+p.x,P+p.y,"view"),this.lineBackground.data.anchor.set("center"),this.lineBackground.update()}for(const p of this.highlights)p.update();this.clearDirty()}}export{C as S,X as t};
