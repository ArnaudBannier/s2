import{v as B,w as z,m as u,k as D,x as H,g as G,p as w,q as S,r as l,y as Y,c as P,n as I,l as q,z as _,A as X,b as k,u as L,f as A,S as E,o as C}from"./s2-playable-Bdq8E5_G.js";import{S as b}from"./s2-lerp-anim-CJb7usyt.js";class j extends X{skip;horizontalAlign;constructor(t){super(t),this.skip=new I(0,t.getViewSpace()),this.horizontalAlign=new l(-1)}setOwner(t=null){super.setOwner(t),this.skip.setOwner(t),this.horizontalAlign.setOwner(t)}clearDirty(){super.clearDirty(),this.skip.clearDirty(),this.horizontalAlign.clearDirty()}}class J extends _{constructor(t){super(t,new j(t))}}class K extends G{fill;stroke;opacity;transform;position;font;skip;horizontalAlign;verticalAlign;minExtents;anchor;constructor(t){super(),this.fill=new w,this.stroke=new S(t),this.opacity=new l(1),this.transform=new Y,this.position=new D(0,0,t.getWorldSpace()),this.font=new P(t),this.skip=new I(0,t.getViewSpace()),this.horizontalAlign=new l(-1),this.verticalAlign=new l(0),this.minExtents=new u(0,0,t.getViewSpace()),this.anchor=new q(0,0),this.stroke.width.set(0,t.getViewSpace()),this.fill.opacity.set(1)}setOwner(t=null){this.fill.setOwner(t),this.stroke.setOwner(t),this.opacity.setOwner(t),this.transform.setOwner(t),this.position.setOwner(t),this.font.setOwner(t),this.skip.setOwner(t),this.horizontalAlign.setOwner(t),this.verticalAlign.setOwner(t),this.minExtents.setOwner(t),this.anchor.setOwner(t)}clearDirty(){super.clearDirty(),this.fill.clearDirty(),this.stroke.clearDirty(),this.opacity.clearDirty(),this.transform.clearDirty(),this.position.clearDirty(),this.font.clearDirty(),this.skip.clearDirty(),this.horizontalAlign.clearDirty(),this.verticalAlign.clearDirty(),this.minExtents.clearDirty(),this.anchor.clearDirty()}}class Q extends B{element;textLines=[];center;textExtents;extents;constructor(t){super(t,new K(t)),this.element=document.createElementNS(z,"g"),this.textExtents=new u(0,0,t.getViewSpace()),this.extents=new u(0,0,t.getViewSpace()),this.center=new D(0,0,t.getWorldSpace()),this.element.dataset.role="text-group"}getSVGElement(){return this.element}addLine(t){const e=new J(this.scene);return e.setParent(this),t?.align!==void 0&&(e.data.horizontalAlign.set(t.align),e.data.horizontalAlign.lock()),t?.skip!==void 0&&(e.data.skip.set(t.skip),e.data.skip.lock()),this.textLines.push(e),this.updateSVGChildren(),this.markDirty(),e}getLineCount(){return this.textLines.length}getLine(t){return this.textLines[t]}getContentExtentsInto(t,e){return this.textExtents.getInto(t,e),this}getExtentsInto(t,e){return this.extents.getInto(t,e),this}getCenterInto(t,e){return this.center.getInto(t,e),this}update(){if(this.skipUpdate()||(this.updateSVGChildren(),this.textLines.length===0))return;H.applyTransform(this.data.transform,this.element,this.scene);const t=this.scene.getViewSpace(),e=this.data.font,s=e.size.get(t),i=e.relativeLineHeight.get()*s,a=this.scene.acquireVec2();this.textExtents.space=t;const n=this.textExtents.value;n.set(0,0);for(const r of this.textLines)r.data.font.copyIfUnlocked(this.data.font),r.data.fill.copyIfUnlocked(this.data.fill),r.data.stroke.copyIfUnlocked(this.data.stroke),r.data.opacity.copyIfUnlocked(this.data.opacity),r.data.horizontalAlign.copyIfUnlocked(this.data.horizontalAlign),r.data.skip.copyIfUnlocked(this.data.skip),r.update(),r.getExtentsInto(a,t),n.x=Math.max(n.x,a.x),n.y+=.5*(i+r.data.skip.get(t));this.extents.space=t;const o=this.extents.value;this.data.minExtents.getInto(o,t),o.maxV(n),this.center.space=t;const h=this.center.value;this.data.position.getInto(h,t),this.data.anchor.getCenterIntoV(h,h,o);const y=t.isDirectSpace()?1:-1,m=e.relativeAscenderHeight.get()*s,V=y*this.data.verticalAlign.get();let p=h.y+V*(o.y-n.y);p+=y*(n.y-i+.5*m);for(let r=0;r<this.textLines.length;r++){const d=this.textLines[r],g=d.data.horizontalAlign.get();d.getExtentsInto(a,t);const f=h.x+g*(o.x-a.x);d.data.position.set(f,p,t),d.update(),p+=i+d.data.skip.get(t)}this.scene.releaseVec2(a),this.clearDirty()}}class T{lower=new k;upper=new k;setFromPoints(t){if(t.length===0)return this.lower.set(0,0),this.upper.set(0,0),this;this.lower.set(1/0,1/0),this.upper.set(-1/0,-1/0);for(const e of t)this.lower.minV(e),this.upper.maxV(e);return this}setEmpty(){return this.lower.set(1/0,1/0),this.upper.set(-1/0,-1/0),this}expandToInclude(t){return this.lower.minV(t),this.upper.maxV(t),this}getCenterInto(t){return t.copy(this.lower).addV(this.upper).scale(.5),this}getExtentsInto(t){return t.copy(this.upper).subV(this.lower).scale(.5),this}isPointInside(t){return t.x>=this.lower.x&&t.x<=this.upper.x&&t.y>=this.lower.y&&t.y<=this.upper.y}expand(t){return this.lower.x-=t,this.lower.y-=t,this.upper.x+=t,this.upper.y+=t,this}clone(){const t=new T;return t.lower.copy(this.lower),t.upper.copy(this.upper),t}copy(t){return this.lower.copy(t.lower),this.upper.copy(t.upper),this}}class Z extends G{fill;stroke;opacity;cornerRadius;padding;constructor(t){super();const e=t.getViewSpace();this.fill=new w,this.stroke=new S(t),this.opacity=new l(1),this.cornerRadius=new I(5,e),this.padding=new u(4,2,e),this.stroke.opacity.set(1),this.fill.opacity.set(1)}setOwner(t=null){this.fill.setOwner(t),this.stroke.setOwner(t),this.opacity.setOwner(t),this.cornerRadius.setOwner(t),this.padding.setOwner(t)}clearDirty(){super.clearDirty(),this.fill.clearDirty(),this.stroke.clearDirty(),this.opacity.clearDirty(),this.cornerRadius.clearDirty(),this.padding.clearDirty()}}class R extends B{rect;references=[];constructor(t){super(t,new Z(t)),this.rect=new L(t),this.rect.getSVGElement().role="text-highlight"}addReference(t){return this.references.push(t),this.markDirty(),this}addReferences(...t){return this.references.push(...t),this.markDirty(),this}clearReferences(){return this.references.length=0,this}getSVGElement(){return this.rect.getSVGElement()}animateFadeIn(t,e={}){const s=t.ensureLabel(e.label),i=e.offset??0,a=e.duration??500;this.data.opacity.set(0);const n=b.create(this.scene,this.data.opacity).setCycleDuration(a).setEasing(A.inOut);return this.data.opacity.set(1),n.commitFinalState(),t.addAnimation(n,s,i),t.enableElement(this,!0,s,i),this}animateFadeOut(t,e={}){const s=t.ensureLabel(e.label),i=e.offset??0,a=e.duration??500;this.data.opacity.set(1);const n=b.create(this.scene,this.data.opacity).setCycleDuration(a).setEasing(A.inOut);return this.data.opacity.set(0),n.commitFinalState(),t.addAnimation(n,s,i),t.enableElement(this,!1,s,i+a),this}update(){if(!this.isDirty()||this.references.length===0)return;const t=this.scene.getViewSpace();x.setEmpty();for(const a of this.references)a.getBBoxInto(O,v,t),x.expandToInclude(O),x.expandToInclude(v);const e=O,s=v,i=$;x.getExtentsInto(e),x.getCenterInto(s),this.data.padding.getInto(i,t),this.rect.data.position.setV(s,t),this.rect.data.extents.set(e.x+i.x,e.y+i.y,t),this.rect.data.anchor.set(0,0),this.rect.data.fill.copyIfUnlocked(this.data.fill),this.rect.data.stroke.copyIfUnlocked(this.data.stroke),this.rect.data.opacity.copyIfUnlocked(this.data.opacity),this.rect.data.cornerRadius.copyIfUnlocked(this.data.cornerRadius),this.rect.update(),this.clearDirty()}}const x=new T,O=new k,v=new k,$=new k;function rt(c){const t=[],e=/\*\*(\w+):(.*?)\*\*|(\s+)|([();,.])|([^\s();,.]+)/g;for(const s of c.split(`
`)){let i;for(;(i=e.exec(s))!==null;)i[1]?t.push({type:i[1],value:i[2]}):i[3]?t.push({type:"space",value:i[3]}):i[4]?t.push({type:"punct",value:i[4]}):i[5]&&t.push({type:"plain",value:i[5]});t.push({type:"newline",value:`
`})}return t.pop(),t}class tt extends G{position;opacity;anchor;padding;minExtents;text;background;currentLine;constructor(t){super(),this.position=new D(0,0,t.getWorldSpace()),this.anchor=new q(0,0),this.padding=new u(10,5,t.getViewSpace()),this.minExtents=new u(0,0,t.getViewSpace()),this.text=new et(t),this.background=new it(t),this.currentLine=new st(t),this.opacity=new l(1)}setOwner(t=null){super.setOwner(t),this.position.setOwner(t),this.anchor.setOwner(t),this.padding.setOwner(t),this.minExtents.setOwner(t),this.text.setOwner(t),this.background.setOwner(t),this.currentLine.setOwner(t),this.opacity.setOwner(t)}clearDirty(){super.clearDirty(),this.position.clearDirty(),this.anchor.clearDirty(),this.padding.clearDirty(),this.minExtents.clearDirty(),this.text.clearDirty(),this.background.clearDirty(),this.currentLine.clearDirty(),this.opacity.clearDirty()}}class et extends C{fill;stroke;opacity;font;verticalAlign;constructor(t){super(),this.fill=new w,this.stroke=new S(t),this.opacity=new l(1),this.font=new P(t),this.verticalAlign=new l(0),this.stroke.width.set(0,t.getViewSpace()),this.fill.opacity.set(1)}setOwner(t=null){this.fill.setOwner(t),this.stroke.setOwner(t),this.opacity.setOwner(t),this.font.setOwner(t),this.verticalAlign.setOwner(t)}clearDirty(){this.fill.clearDirty(),this.stroke.clearDirty(),this.opacity.clearDirty(),this.font.clearDirty(),this.verticalAlign.clearDirty()}}class it extends C{fill;stroke;opacity;cornerRadius;constructor(t){super(),this.fill=new w,this.stroke=new S(t),this.opacity=new l(1),this.cornerRadius=new I(5,t.getViewSpace()),this.stroke.opacity.set(1),this.fill.opacity.set(1)}setOwner(t=null){this.fill.setOwner(t),this.stroke.setOwner(t),this.opacity.setOwner(t),this.cornerRadius.setOwner(t)}clearDirty(){this.fill.clearDirty(),this.stroke.clearDirty(),this.opacity.clearDirty(),this.cornerRadius.clearDirty()}}class st extends C{fill;stroke;opacity;index;padding;constructor(t){super(),this.fill=new w,this.stroke=new S(t),this.opacity=new l(0),this.index=new l(0),this.padding=new u(0,1,t.getViewSpace()),this.stroke.opacity.set(1),this.fill.opacity.set(1)}setOwner(t=null){this.fill.setOwner(t),this.stroke.setOwner(t),this.opacity.setOwner(t),this.index.setOwner(t),this.padding.setOwner(t)}clearDirty(){this.fill.clearDirty(),this.stroke.clearDirty(),this.opacity.clearDirty(),this.index.clearDirty(),this.padding.clearDirty()}}class M extends B{element;textGroup;codeBackground;lineBackground;extents;highlights=[];center;tokenStyleSetter=M.defaultTokenStyleSetter;constructor(t){super(t,new tt(t)),this.element=document.createElementNS(z,"g"),this.textGroup=new Q(t),this.codeBackground=new L(t),this.lineBackground=new L(t),this.extents=new u(0,0,t.getViewSpace()),this.center=new D(0,0,t.getViewSpace()),this.textGroup.setParent(this),this.codeBackground.setParent(this),this.lineBackground.setParent(this),this.textGroup.data.layer.set(2),this.codeBackground.data.layer.set(0),this.lineBackground.data.layer.set(0),this.element.dataset.role="code",this.updateSVGChildren()}setTokenStyleSetter(t){return this.tokenStyleSetter=t,this}static defaultTokenStyleSetter(t,e){switch(e){case"fn":t.data.fill.color.setFromHex("#ffcd82").lock();break;case"type":t.data.fill.color.setFromHex("#70B8FF").lock();break;case"kw":t.data.fill.color.setFromHex("#E796F3").lock();break;case"var":t.data.fill.color.setFromHex("#B6ECF7").lock();break;case"num":t.data.fill.color.setFromHex("#E3F7BA").lock();break;case"str":t.data.fill.color.setFromHex("#ffac97").lock();break;case"punct":t.data.fill.color.setFromHex("#E9C2EC").lock();break}}animateSetCurrentLine(t,e,s={}){const i=e.ensureLabel(s.label),a=s.offset??0,n=s.duration??500;s.prevIndex!==void 0&&this.data.currentLine.index.set(s.prevIndex);const o=b.create(this.scene,this.data.currentLine.index).setCycleDuration(n).setEasing(A.inOut);return this.data.currentLine.index.set(t),e.addAnimation(o.commitFinalState(),i,a),this}findTokenTSpan(t,e){return this.textGroup.getLine(t).findTSpan(e)}createTokenHighlight(t,e){const s=new R(this.scene);s.data.fill.opacity.set(.15),e?(s.data.fill.color.copyIfUnlocked(e),s.data.stroke.color.copyIfUnlocked(e)):(s.data.fill.color.setFromHex("#00BEFD28"),s.data.stroke.color.setFromHex("#11809C")),s.data.stroke.width.set(1,this.scene.getViewSpace()),s.data.layer.set(1),s.setParent(this);for(const i of t){const a=this.findTokenTSpan(i.lineIndex,{content:i.content,category:i.category});a?s.addReference(a):console.warn("Token not found for highlight:",i)}return this.highlights.push(s),s}createEmphasisForToken(t,e){const s=this.findTokenTSpan(t,e);if(!s)return null;const i=new R(this.scene);return i.data.fill.opacity.set(.15),i.data.fill.color.setFromHex("#00BEFD28"),i.data.stroke.color.setFromHex("#11809C"),i.data.stroke.width.set(1,this.scene.getViewSpace()),i.data.layer.set(1),i.setParent(this),i.addReference(s),i.update(),this.highlights.push(i),i}detachEmphasisRect(t){const e=this.highlights.indexOf(t);return e!==-1&&this.highlights.splice(e,1),t.setParent(null),this}setContent(t){let e=this.textGroup.addLine();for(const s of t)if(e.data.preserveWhitespace.set(!0),s.type==="plain")e.addTSpan(s.value);else if(s.type==="newline")e=this.textGroup.addLine();else{const i=e.addTSpan(s.value,s.type);this.tokenStyleSetter(i,s.type)}}getExtents(t){return this.extents.get(t)}getSVGElement(){return this.element}update(){if(this.skipUpdate())return;const t=this.scene.getViewSpace();this.updateSVGChildren(),H.applyOpacity(this.data.opacity,this.element,this.scene),this.textGroup.data.font.copyIfUnlocked(this.data.text.font),this.textGroup.data.horizontalAlign.set(-1),this.textGroup.data.verticalAlign.copyIfUnlocked(this.data.text.verticalAlign),this.textGroup.data.fill.copyIfUnlocked(this.data.text.fill),this.textGroup.data.opacity.copyIfUnlocked(this.data.text.opacity),this.textGroup.data.stroke.copyIfUnlocked(this.data.text.stroke),this.textGroup.update(),this.extents.space=t;const e=this.extents.value,s=this.scene.acquireVec2(),i=this.scene.acquireVec2(),a=this.scene.acquireVec2();this.textGroup.getExtentsInto(e,t),this.data.padding.getInto(i,t),this.data.minExtents.getInto(a,t),e.addV(i).maxV(a),s.copy(e).subV(i),this.center.space=t;const n=this.center.value;this.data.position.getInto(n,t),this.data.anchor.getCenterIntoV(n,n,e),this.textGroup.data.minExtents.setV(s,t),this.textGroup.data.position.setV(n,t),this.textGroup.update(),this.scene.releaseVec2(s),this.scene.releaseVec2(i),this.scene.releaseVec2(a),this.codeBackground.data.position.setV(n,t),this.codeBackground.data.extents.setV(e,t),this.codeBackground.data.cornerRadius.copyIfUnlocked(this.data.background.cornerRadius),this.codeBackground.data.fill.copyIfUnlocked(this.data.background.fill),this.codeBackground.data.stroke.copyIfUnlocked(this.data.background.stroke),this.codeBackground.data.opacity.copyIfUnlocked(this.data.background.opacity),this.codeBackground.update(),this.lineBackground.data.fill.copyIfUnlocked(this.data.currentLine.fill),this.lineBackground.data.stroke.copyIfUnlocked(this.data.currentLine.stroke),this.lineBackground.data.opacity.copyIfUnlocked(this.data.currentLine.opacity);const o=this.textGroup.getLineCount();if(o>0){const h=this.data.currentLine.padding.get(t),y=E.clamp(this.data.currentLine.index.get(),0,o-1),m=E.clamp(Math.floor(y),0,o-1),V=E.clamp(Math.ceil(y),0,o-1),p=y-m,r=this.scene.acquireVec2(),d=this.scene.acquireVec2(),g=this.scene.acquireVec2(),f=this.scene.acquireVec2(),F=this.textGroup.getLine(m),U=this.textGroup.getLine(V);F.getExtentsInto(r,t),U.getExtentsInto(d,t),F.getCenterInto(g,t),U.getCenterInto(f,t);const N=r.y*(1-p)+d.y*p,W=g.y*(1-p)+f.y*p;this.lineBackground.data.position.set(n.x,W,t),this.lineBackground.data.extents.set(e.x+h.x,N+h.y,t),this.lineBackground.data.anchor.set(0,0),this.lineBackground.update(),this.scene.releaseVec2(r),this.scene.releaseVec2(d),this.scene.releaseVec2(g),this.scene.releaseVec2(f)}for(const h of this.highlights)(this.data.position.isDirty()||this.data.anchor.isDirty()||this.data.padding.isDirty())&&h.markDirty(),h.update();this.clearDirty()}}export{M as S,rt as t};
