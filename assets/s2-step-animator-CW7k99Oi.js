import{D as m,C as g,b as l}from"./s2-lerp-anim-3QYG2S63.js";class u{property;constructor(t){this.property=t}}class h extends u{value;constructor(t,e){super(t),this.value=e}onTrigger(){this.property.set(this.value)}}class T extends u{value;constructor(t,e){super(t),this.value=e}onTrigger(){this.property.copy(this.value)}}class p{animation;trigger;start;end;constructor(t){this.start=t,this.end=t,this.animation=null,this.trigger=null}getStart(){return this.start}getEnd(){return this.end}getAnimation(){return this.animation}getTrigger(){return this.trigger}setAnimation(t){this.animation=t,this.updateEnd()}setTrigger(t){this.trigger=t,this.updateEnd()}setElapsedProperty(t,e){if(this.animation)if(e<=this.start)this.animation.setElapsedProperty(t,0);else if(e>=this.end)this.animation.setElapsedProperty(t,this.animation.getDuration());else{const s=e-this.start;this.animation.setElapsedProperty(t,s)}this.trigger&&e>=this.start&&this.trigger.onTrigger(),!this.animation&&!this.trigger&&console.warn("S2TimelinePart: No animation assigned.")}updateEnd(){const t=this.animation?this.animation.getDuration():0;this.end=this.start+t}}class d{property;sortedParts=[];constructor(t){this.property=t}getPartCount(){return this.sortedParts.length}addPart(t){this.sortedParts.push(t),this.sortedParts.sort((e,s)=>e.getStart()-s.getStart()),this.validateParts()}validateParts(){for(let e=0;e<this.sortedParts.length-1;e++)this.sortedParts[e].getEnd()>this.sortedParts[e+1].getStart()+1e-6&&console.warn("S2Timeline: Overlapping animations on the same target are not supported.",this.property,this.sortedParts[e],this.sortedParts[e+1])}getActivePart(t){if(this.sortedParts.length===0)return console.warn("S2TimelineTargetParts: No parts available."),null;if(t<=this.sortedParts[0].getStart())return this.sortedParts[0];for(let e=0;e<this.sortedParts.length-1;e++)if(t<this.sortedParts[e+1].getStart())return this.sortedParts[e];return this.sortedParts[this.sortedParts.length-1]}setElapsed(t){this.getActivePart(t)?.setElapsedProperty(this.property,t)}}class o extends m{parts;propertyTrackMap;labelToTime;labelId;static reservedLabelNames=["timeline-start","timeline-end","absolute","previous-start","previous-end"];constructor(t){super(t),this.cycleDuration=0,this.parts=[],this.propertyTrackMap=new Map,this.labelToTime=new Map,this.labelId=0}addLabel(t,e){return o.reservedLabelNames.includes(t)?(console.warn(`Label name '${t}' is reserved and cannot be used.`),this):(this.labelToTime.has(t)&&console.warn(`Label '${t}' already exists. Overwriting.`),this.labelToTime.set(t,e),this)}addLabelAtCurrentTime(t){return this.addLabel(t,this.cycleDuration),this}createLabelAtCurrentTime(){const t=`@-auto-label-${this.labelId++}`;return this.addLabelAtCurrentTime(t),t}hasLabel(t){return this.labelToTime.has(t)}getLabelTime(t,e=0){switch(t){case"timeline-end":return this.cycleDuration+e;case"absolute":case"timeline-start":return e;case"previous-end":return this.parts.length>0?this.parts[this.parts.length-1].getEnd()+e:e;case"previous-start":return this.parts.length>0?this.parts[this.parts.length-1].getStart()+e:e}const s=this.labelToTime.get(t);return s!==void 0?s+e:(console.warn(`Label '${t}' not found. Using offset as absolute time.`),e)}addAnimation(t,e="timeline-end",s=0){const r=this.getLabelTime(e,s),i=new p(r);return i.setAnimation(t),this.addPart(i),this}addTrigger(t,e="timeline-end",s=0){const r=this.getLabelTime(e,s),i=new p(r);return i.setTrigger(t),this.addPart(i),this}enableElement(t,e,s="timeline-end",r=0){const i=this.getLabelTime(s,r),a=t.data.isEnabled;return this.propertyTrackMap.has(a)?this.addTrigger(new h(a,e),"absolute",i):i<=0?this.addTrigger(new h(a,e),"timeline-start"):(this.addTrigger(new h(a,!e),"timeline-start"),this.addTrigger(new h(a,e),"absolute",i)),this}addPart(t){this.cycleDuration=Math.max(this.cycleDuration,t.getEnd()),this.updateRawDuration();let e=null;const s=t.getAnimation(),r=t.getTrigger();s?e=s.getProperties():r?e=new Set([r.property]):(console.warn("S2Timeline: No animation or trigger assigned."),e=new Set);for(const i of e)this.properties.add(i),this.createOrGetPropertyTrack(i).addPart(t);this.parts.push(t)}createOrGetPropertyTrack(t){let e=this.propertyTrackMap.get(t);return e||(e=new d(t),this.propertyTrackMap.set(t,e),e)}setElapsedPropertyImpl(t){const e=this.propertyTrackMap.get(t);e!==void 0&&e.setElapsed(this.wrapedCycleElapsed)}}class b{scene;timeline;playable;stepTimes;labelId;constructor(t){this.scene=t,this.timeline=new o(this.scene),this.playable=new g(this.timeline),this.stepTimes=[0],this.labelId=0}finalize(){return this.makeStep(),this}getStepIndexFromElapsed(t){for(let e=0;e<this.stepTimes.length-1;e++)if(t>=this.stepTimes[e]&&t<this.stepTimes[e+1])return e;return this.stepTimes.length-1}getStepStartTime(t){return t=l.clamp(t,0,this.stepTimes.length-2),this.stepTimes[t]}playStep(t){return t=l.clamp(t,0,this.stepTimes.length-2),this.stop(),this.timeline.setElapsed(this.stepTimes[t]),this.playable.setRange(this.stepTimes[t],this.stepTimes[t+1]),this.playable.play(),this}playMaster(){return this.stop(),this.playable.setRange(0,this.timeline.getDuration()),this.playable.play(),this}isPlaying(){return this.playable.isPlaying()}isPaused(){return this.playable.isPaused()}pause(){return this.playable.pause(),this}resume(){return this.playable.resume(),this}resetStep(t){return t=l.clamp(t,0,this.stepTimes.length-1),this.timeline.setElapsed(this.stepTimes[t]),this}reset(){return this.timeline.setElapsed(0),this.scene.getSVG().update(),this}stop(){return this.playable.stop(),this}setMasterElapsed(t){return this.timeline.setElapsed(t),this}getMasterDuration(){return this.timeline.getDuration()}getStepDuration(t){return t=l.clamp(t,0,this.stepTimes.length-2),this.stepTimes[t+1]-this.stepTimes[t]}getStepCount(){return this.stepTimes.length-1}makeStep(){return this.timeline.getDuration()>this.stepTimes[this.stepTimes.length-1]&&this.stepTimes.push(this.timeline.getDuration()),this}addAnimation(t,e,s=0){return this.timeline.addAnimation(t,e,s),this}addTrigger(t,e,s=0){return this.timeline.addTrigger(t,e,s),this}addLabel(t,e){return this.timeline.addLabel(t,e),this}addLabelAtCurrentTime(t){return this.timeline.addLabelAtCurrentTime(t),this}createLabelAtCurrentTime(){const t=`step-${this.stepTimes.length-1}-id-${this.labelId++}`;return this.timeline.addLabelAtCurrentTime(t),t}ensureLabel(t){return t?(this.timeline.hasLabel(t)||this.timeline.addLabelAtCurrentTime(t),t):this.createLabelAtCurrentTime()}enableElement(t,e,s,r=0){return this.timeline.enableElement(t,e,s,r),this}getCurrentStepDuration(){return this.timeline.getCycleDuration()}getMasterTimeline(){return this.timeline}getStepTimeline(t){return this.timeline}getStepPlayable(t){return this.playable.setRange(this.stepTimes[t],this.stepTimes[t+1]),this.playable}getMasterPlayable(){return this.playable}}export{b as S,T as a};
