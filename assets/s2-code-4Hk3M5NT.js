import{v as b,w as _,m as y,k as I,x as F,h as B,p as S,q as m,r as l,y as Y,c as q,n as E,l as H,z as X,A as j,b as w,u as v,g as A,S as O,o as T}from"./s2-playable-CCYpOjF1.js";import{M as d}from"./mtl-colors-BFHaR8KK.js";import{S as G}from"./s2-lerp-anim-BiCWT6VV.js";class J extends j{skip;horizontalAlign;constructor(t){super(t),this.skip=new E(0,t.getViewSpace()),this.horizontalAlign=new l(-1)}setOwner(t=null){super.setOwner(t),this.skip.setOwner(t),this.horizontalAlign.setOwner(t)}clearDirty(){super.clearDirty(),this.skip.clearDirty(),this.horizontalAlign.clearDirty()}}class K extends X{constructor(t){super(t,new J(t))}}class Q extends B{fill;stroke;opacity;transform;position;font;skip;horizontalAlign;verticalAlign;minExtents;anchor;constructor(t){super(),this.fill=new S,this.stroke=new m(t),this.opacity=new l(1),this.transform=new Y,this.position=new I(0,0,t.getWorldSpace()),this.font=new q(t),this.skip=new E(0,t.getViewSpace()),this.horizontalAlign=new l(-1),this.verticalAlign=new l(0),this.minExtents=new y(0,0,t.getViewSpace()),this.anchor=new H(0,0),this.stroke.width.set(0,t.getViewSpace()),this.fill.opacity.set(1)}setOwner(t=null){this.fill.setOwner(t),this.stroke.setOwner(t),this.opacity.setOwner(t),this.transform.setOwner(t),this.position.setOwner(t),this.font.setOwner(t),this.skip.setOwner(t),this.horizontalAlign.setOwner(t),this.verticalAlign.setOwner(t),this.minExtents.setOwner(t),this.anchor.setOwner(t)}clearDirty(){super.clearDirty(),this.fill.clearDirty(),this.stroke.clearDirty(),this.opacity.clearDirty(),this.transform.clearDirty(),this.position.clearDirty(),this.font.clearDirty(),this.skip.clearDirty(),this.horizontalAlign.clearDirty(),this.verticalAlign.clearDirty(),this.minExtents.clearDirty(),this.anchor.clearDirty()}}class Z extends b{element;textLines=[];center;textExtents;extents;constructor(t){super(t,new Q(t)),this.element=document.createElementNS(_,"g"),this.textExtents=new y(0,0,t.getViewSpace()),this.extents=new y(0,0,t.getViewSpace()),this.center=new I(0,0,t.getWorldSpace()),this.element.dataset.role="text-group"}getSVGElement(){return this.element}addLine(t){const e=new K(this.scene);return e.setParent(this),t?.align!==void 0&&(e.data.horizontalAlign.set(t.align),e.data.horizontalAlign.lock()),t?.skip!==void 0&&(e.data.skip.set(t.skip),e.data.skip.lock()),this.textLines.push(e),this.updateSVGChildren(),this.markDirty(),e}getLineCount(){return this.textLines.length}getLine(t){return this.textLines[t]}getContentExtentsInto(t,e){return this.textExtents.getInto(t,e),this}getExtentsInto(t,e){return this.extents.getInto(t,e),this}getCenterInto(t,e){return this.center.getInto(t,e),this}update(){if(this.skipUpdate()||(this.updateSVGChildren(),this.textLines.length===0))return;F.applyTransform(this.data.transform,this.element,this.scene);const t=this.scene.getViewSpace(),e=this.data.font,s=e.size.get(t),i=e.relativeLineHeight.get()*s,a=this.scene.acquireVec2();this.textExtents.space=t;const n=this.textExtents.value;n.set(0,0);for(const r of this.textLines)r.data.font.copyIfUnlocked(this.data.font),r.data.fill.copyIfUnlocked(this.data.fill),r.data.stroke.copyIfUnlocked(this.data.stroke),r.data.opacity.copyIfUnlocked(this.data.opacity),r.data.horizontalAlign.copyIfUnlocked(this.data.horizontalAlign),r.data.skip.copyIfUnlocked(this.data.skip),r.update(),r.getExtentsInto(a,t),n.x=Math.max(n.x,a.x),n.y+=.5*(i+r.data.skip.get(t));this.extents.space=t;const o=this.extents.value;this.data.minExtents.getInto(o,t),o.maxV(n),this.center.space=t;const h=this.center.value;this.data.position.getInto(h,t),this.data.anchor.getCenterIntoV(h,h,o);const g=t.isDirectSpace()?1:-1,D=e.relativeAscenderHeight.get()*s,V=g*this.data.verticalAlign.get();let u=h.y+V*(o.y-n.y);u+=g*(n.y-i+.5*D);for(let r=0;r<this.textLines.length;r++){const p=this.textLines[r],f=p.data.horizontalAlign.get();p.getExtentsInto(a,t);const x=h.x+f*(o.x-a.x);p.data.position.set(x,u,t),p.update(),u+=i+p.data.skip.get(t)}this.scene.releaseVec2(a),this.clearDirty()}}class C{lower=new w;upper=new w;setFromPoints(t){if(t.length===0)return this.lower.set(0,0),this.upper.set(0,0),this;this.lower.set(1/0,1/0),this.upper.set(-1/0,-1/0);for(const e of t)this.lower.minV(e),this.upper.maxV(e);return this}setEmpty(){return this.lower.set(1/0,1/0),this.upper.set(-1/0,-1/0),this}expandToInclude(t){return this.lower.minV(t),this.upper.maxV(t),this}getCenterInto(t){return t.copy(this.lower).addV(this.upper).scale(.5),this}getExtentsInto(t){return t.copy(this.upper).subV(this.lower).scale(.5),this}isPointInside(t){return t.x>=this.lower.x&&t.x<=this.upper.x&&t.y>=this.lower.y&&t.y<=this.upper.y}expand(t){return this.lower.x-=t,this.lower.y-=t,this.upper.x+=t,this.upper.y+=t,this}clone(){const t=new C;return t.lower.copy(this.lower),t.upper.copy(this.upper),t}copy(t){return this.lower.copy(t.lower),this.upper.copy(t.upper),this}}class $ extends B{fill;stroke;opacity;cornerRadius;padding;constructor(t){super();const e=t.getViewSpace();this.fill=new S,this.stroke=new m(t),this.opacity=new l(1),this.cornerRadius=new E(5,e),this.padding=new y(4,2,e),this.stroke.opacity.set(1),this.fill.opacity.set(1)}setOwner(t=null){this.fill.setOwner(t),this.stroke.setOwner(t),this.opacity.setOwner(t),this.cornerRadius.setOwner(t),this.padding.setOwner(t)}clearDirty(){super.clearDirty(),this.fill.clearDirty(),this.stroke.clearDirty(),this.opacity.clearDirty(),this.cornerRadius.clearDirty(),this.padding.clearDirty()}}class P extends b{rect;references=[];constructor(t){super(t,new $(t)),this.rect=new v(t),this.rect.getSVGElement().role="text-highlight"}addReference(t){return this.references.push(t),this.markDirty(),this}addReferences(...t){return this.references.push(...t),this.markDirty(),this}clearReferences(){return this.references.length=0,this}getSVGElement(){return this.rect.getSVGElement()}animateFadeIn(t,e={}){const s=t.ensureLabel(e.label),i=e.offset??0,a=e.duration??500;this.data.opacity.set(0);const n=G.create(this.scene,this.data.opacity).setCycleDuration(a).setEasing(A.inOut);return this.data.opacity.set(1),n.commitFinalState(),t.addAnimation(n,s,i),t.enableElement(this,!0,s,i),this}animateFadeOut(t,e={}){const s=t.ensureLabel(e.label),i=e.offset??0,a=e.duration??500;this.data.opacity.set(1);const n=G.create(this.scene,this.data.opacity).setCycleDuration(a).setEasing(A.inOut);return this.data.opacity.set(0),n.commitFinalState(),t.addAnimation(n,s,i),t.enableElement(this,!1,s,i+a),this}update(){if(!this.isDirty()||this.references.length===0)return;const t=this.scene.getViewSpace();k.setEmpty();for(const a of this.references)a.getBBoxInto(L,U,t),k.expandToInclude(L),k.expandToInclude(U);const e=L,s=U,i=tt;k.getExtentsInto(e),k.getCenterInto(s),this.data.padding.getInto(i,t),this.rect.data.position.setV(s,t),this.rect.data.extents.set(e.x+i.x,e.y+i.y,t),this.rect.data.anchor.set(0,0),this.rect.data.fill.copyIfUnlocked(this.data.fill),this.rect.data.stroke.copyIfUnlocked(this.data.stroke),this.rect.data.opacity.copyIfUnlocked(this.data.opacity),this.rect.data.cornerRadius.copyIfUnlocked(this.data.cornerRadius),this.rect.update(),this.clearDirty()}}const k=new C,L=new w,U=new w,tt=new w;function ct(c){const t=[],e=/\*\*(\w+):(.*?)\*\*|(\s+)|([();,.])|([^\s();,.]+)/g;for(const s of c.split(`
`)){let i;for(;(i=e.exec(s))!==null;)i[1]?t.push({type:i[1],value:i[2]}):i[3]?t.push({type:"space",value:i[3]}):i[4]?t.push({type:"punct",value:i[4]}):i[5]&&t.push({type:"plain",value:i[5]});t.push({type:"newline",value:`
`})}return t.pop(),t}class et extends B{position;opacity;anchor;padding;minExtents;text;background;currentLine;constructor(t){super(),this.position=new I(0,0,t.getWorldSpace()),this.anchor=new H(0,0),this.padding=new y(10,5,t.getViewSpace()),this.minExtents=new y(0,0,t.getViewSpace()),this.text=new it(t),this.background=new st(t),this.currentLine=new nt(t),this.opacity=new l(1)}setOwner(t=null){super.setOwner(t),this.position.setOwner(t),this.anchor.setOwner(t),this.padding.setOwner(t),this.minExtents.setOwner(t),this.text.setOwner(t),this.background.setOwner(t),this.currentLine.setOwner(t),this.opacity.setOwner(t)}clearDirty(){super.clearDirty(),this.position.clearDirty(),this.anchor.clearDirty(),this.padding.clearDirty(),this.minExtents.clearDirty(),this.text.clearDirty(),this.background.clearDirty(),this.currentLine.clearDirty(),this.opacity.clearDirty()}}class it extends T{fill;stroke;opacity;font;verticalAlign;constructor(t){super(),this.fill=new S,this.stroke=new m(t),this.opacity=new l(1),this.font=new q(t),this.verticalAlign=new l(0),this.stroke.width.set(0,t.getViewSpace()),this.fill.opacity.set(1)}setOwner(t=null){this.fill.setOwner(t),this.stroke.setOwner(t),this.opacity.setOwner(t),this.font.setOwner(t),this.verticalAlign.setOwner(t)}clearDirty(){this.fill.clearDirty(),this.stroke.clearDirty(),this.opacity.clearDirty(),this.font.clearDirty(),this.verticalAlign.clearDirty()}}class st extends T{fill;stroke;opacity;cornerRadius;constructor(t){super(),this.fill=new S,this.stroke=new m(t),this.opacity=new l(1),this.cornerRadius=new E(5,t.getViewSpace()),this.stroke.opacity.set(1),this.fill.opacity.set(1)}setOwner(t=null){this.fill.setOwner(t),this.stroke.setOwner(t),this.opacity.setOwner(t),this.cornerRadius.setOwner(t)}clearDirty(){this.fill.clearDirty(),this.stroke.clearDirty(),this.opacity.clearDirty(),this.cornerRadius.clearDirty()}}class nt extends T{fill;stroke;opacity;index;padding;constructor(t){super(),this.fill=new S,this.stroke=new m(t),this.opacity=new l(0),this.index=new l(0),this.padding=new y(0,1,t.getViewSpace()),this.stroke.opacity.set(1),this.fill.opacity.set(1)}setOwner(t=null){this.fill.setOwner(t),this.stroke.setOwner(t),this.opacity.setOwner(t),this.index.setOwner(t),this.padding.setOwner(t)}clearDirty(){this.fill.clearDirty(),this.stroke.clearDirty(),this.opacity.clearDirty(),this.index.clearDirty(),this.padding.clearDirty()}}class M extends b{element;textGroup;codeBackground;lineBackground;extents;highlights=[];center;tokenStyleSetter=M.defaultTokenStyleSetter;constructor(t){super(t,new et(t)),this.element=document.createElementNS(_,"g"),this.textGroup=new Z(t),this.codeBackground=new v(t),this.lineBackground=new v(t),this.extents=new y(0,0,t.getViewSpace()),this.center=new I(0,0,t.getViewSpace()),this.textGroup.setParent(this),this.codeBackground.setParent(this),this.lineBackground.setParent(this),this.textGroup.data.layer.set(2),this.codeBackground.data.layer.set(0),this.lineBackground.data.layer.set(0),this.element.dataset.role="code",this.updateSVGChildren()}setTokenStyleSetter(t){return this.tokenStyleSetter=t,this}static defaultTokenStyleSetter(t,e){switch(e){case"fn":t.data.fill.color.copyIfUnlocked(d.ORANGE_2).lock();break;case"type":t.data.fill.color.copyIfUnlocked(d.BLUE_3).lock();break;case"kw":t.data.fill.color.copyIfUnlocked(d.PURPLE_3).lock();break;case"var":t.data.fill.color.copyIfUnlocked(d.LIGHT_BLUE_1).lock();break;case"num":t.data.fill.color.copyIfUnlocked(d.LIME_2).lock();break;case"str":t.data.fill.color.copyIfUnlocked(d.DEEP_ORANGE_2).lock();break;case"punct":t.data.fill.color.copyIfUnlocked(d.PURPLE_1).lock();break}}animateSetCurrentLine(t,e,s={}){const i=e.ensureLabel(s.label),a=s.offset??0,n=s.duration??500;s.prevIndex!==void 0&&this.data.currentLine.index.set(s.prevIndex);const o=G.create(this.scene,this.data.currentLine.index).setCycleDuration(n).setEasing(A.inOut);return this.data.currentLine.index.set(t),e.addAnimation(o.commitFinalState(),i,a),this}findTokenTSpan(t,e){return this.textGroup.getLine(t).findTSpan(e)}createTokenHighlight(t,e){const s=e??d.BLUE_5,i=new P(this.scene);i.data.fill.opacity.set(.15),i.data.fill.color.copyIfUnlocked(s),i.data.stroke.color.copyIfUnlocked(s),i.data.stroke.width.set(1,this.scene.getViewSpace()),i.data.layer.set(1),i.setParent(this);for(const a of t){const n=this.findTokenTSpan(a.lineIndex,{content:a.content,category:a.category});n?i.addReference(n):console.warn("Token not found for highlight:",a)}return this.highlights.push(i),i}createEmphasisForToken(t,e){const s=this.findTokenTSpan(t,e);if(!s)return null;const i=new P(this.scene);return i.data.fill.opacity.set(.2),i.data.fill.color.copyIfUnlocked(d.BLUE_9),i.data.stroke.color.copyIfUnlocked(d.BLUE_5),i.data.stroke.width.set(1,this.scene.getViewSpace()),i.data.layer.set(1),i.setParent(this),i.addReference(s),i.update(),this.highlights.push(i),i}detachEmphasisRect(t){const e=this.highlights.indexOf(t);return e!==-1&&this.highlights.splice(e,1),t.setParent(null),this}setContent(t){let e=this.textGroup.addLine();for(const s of t)if(e.data.preserveWhitespace.set(!0),s.type==="plain")e.addTSpan(s.value);else if(s.type==="newline")e=this.textGroup.addLine();else{const i=e.addTSpan(s.value,s.type);this.tokenStyleSetter(i,s.type)}}getExtents(t){return this.extents.get(t)}getSVGElement(){return this.element}update(){if(this.skipUpdate())return;const t=this.scene.getViewSpace();this.updateSVGChildren(),F.applyOpacity(this.data.opacity,this.element,this.scene),this.textGroup.data.font.copyIfUnlocked(this.data.text.font),this.textGroup.data.horizontalAlign.set(-1),this.textGroup.data.verticalAlign.copyIfUnlocked(this.data.text.verticalAlign),this.textGroup.data.fill.copyIfUnlocked(this.data.text.fill),this.textGroup.data.opacity.copyIfUnlocked(this.data.text.opacity),this.textGroup.data.stroke.copyIfUnlocked(this.data.text.stroke),this.textGroup.update(),this.extents.space=t;const e=this.extents.value,s=this.scene.acquireVec2(),i=this.scene.acquireVec2(),a=this.scene.acquireVec2();this.textGroup.getExtentsInto(e,t),this.data.padding.getInto(i,t),this.data.minExtents.getInto(a,t),e.addV(i).maxV(a),s.copy(e).subV(i),this.center.space=t;const n=this.center.value;this.data.position.getInto(n,t),this.data.anchor.getCenterIntoV(n,n,e),this.textGroup.data.minExtents.setV(s,t),this.textGroup.data.position.setV(n,t),this.textGroup.update(),this.scene.releaseVec2(s),this.scene.releaseVec2(i),this.scene.releaseVec2(a),this.codeBackground.data.position.setV(n,t),this.codeBackground.data.extents.setV(e,t),this.codeBackground.data.cornerRadius.copyIfUnlocked(this.data.background.cornerRadius),this.codeBackground.data.fill.copyIfUnlocked(this.data.background.fill),this.codeBackground.data.stroke.copyIfUnlocked(this.data.background.stroke),this.codeBackground.data.opacity.copyIfUnlocked(this.data.background.opacity),this.codeBackground.update(),this.lineBackground.data.fill.copyIfUnlocked(this.data.currentLine.fill),this.lineBackground.data.stroke.copyIfUnlocked(this.data.currentLine.stroke),this.lineBackground.data.opacity.copyIfUnlocked(this.data.currentLine.opacity);const o=this.textGroup.getLineCount();if(o>0){const h=this.data.currentLine.padding.get(t),g=O.clamp(this.data.currentLine.index.get(),0,o-1),D=O.clamp(Math.floor(g),0,o-1),V=O.clamp(Math.ceil(g),0,o-1),u=g-D,r=this.scene.acquireVec2(),p=this.scene.acquireVec2(),f=this.scene.acquireVec2(),x=this.scene.acquireVec2(),R=this.textGroup.getLine(D),z=this.textGroup.getLine(V);R.getExtentsInto(r,t),z.getExtentsInto(p,t),R.getCenterInto(f,t),z.getCenterInto(x,t);const N=r.y*(1-u)+p.y*u,W=f.y*(1-u)+x.y*u;this.lineBackground.data.position.set(n.x,W,t),this.lineBackground.data.extents.set(e.x+h.x,N+h.y,t),this.lineBackground.data.anchor.set(0,0),this.lineBackground.update(),this.scene.releaseVec2(r),this.scene.releaseVec2(p),this.scene.releaseVec2(f),this.scene.releaseVec2(x)}for(const h of this.highlights)(this.data.position.isDirty()||this.data.anchor.isDirty()||this.data.padding.isDirty())&&h.markDirty(),h.update();this.clearDirty()}}export{M as S,ct as t};
